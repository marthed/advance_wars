<html>
  <head>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="main-container">
      <div id="stats" class="stats">
        <div id="stats-day" class="stats-item">Day: 1</div>
        <div id="stats-player" class="stats-item">Player 1</div>
        <button id="end-turn" class="stats-button">End turn</button>
      </div>
      <div id="map" class="grid-container"></div>
    </div>

    <script>
      /* Generate Map */
      const htmlMap = document.getElementById('map');

      const size = 20 * 40;

      for (let i = 0; i < size; i++) {
        const element = document.createElement('div');
        element.setAttribute('class', 'grid-item');
        element.id = 'tile-' + i;

        if (i < size / 2) {
          if (Math.random() < 0.2) {
            element.setAttribute('class', 'terrain-forest');
          } else {
            element.setAttribute('class', 'terrain-field');
          }
        } else {
          element.setAttribute('class', 'terrain-water');
        }

        htmlMap.appendChild(element);
      }
    </script>

    <script>
      /* Classes */
      class TileData {
        id = '';
        terrainColor = '';
        element = null;
        command = '';

        constructor(id, t, e, c) {
          this.id = id;
          this.terrainColor = t;
          this.element = e;
          this.command = c;
        }
      }

      class Unit {
        id = '';
        type = '';
        movementRange = 0;
        canMoveInTerrain = ['field', 'forest', 'mountain', 'water'];
        tileElement = null;

        constructor(type) {
          this.id = GenerateId();
          this.type = type;
          const { canMoveInTerrain, movementRange } = GetUnitLogic(type);
          this.canMoveInTerrain = canMoveInTerrain;
          this.movementRange = movementRange;
        }
      }
    </script>

    <script>
      /* Functions */

      function GenerateId() {
        return 'unitId-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
      }

      function GetUnitLogic(type = '') {
        if (type === 'infantry') {
          return {
            movementRange: 3,
            canMoveInTerrain: ['field', 'forest', 'mountain'],
          };
        }
        if (type === 'tank') {
          return { movementRange: 6, canMoveInTerrain: ['field', 'forest'] };
        }
        return { movementRange: 0, canMoveInTerrain: [] };
      }

      function AddUnitImage(tile, unit, player) {
        const { type, id } = unit;
        const img = document.createElement('img');

        const color = GlobalState.playerColors[player];

        if (type === 'infantry') {
          img.src = `units/${type}_${color}.png`;
        } else {
          img.src = `units/${type}.png`;
        }

        img.style.pointerEvents = 'none';
        img.style.height = '40px';
        img.style.width = '40px';
        img.setAttribute('class', 'overlay-image');
        img.setAttribute('class', 'unit');
        img.id = id;
        return img;
      }

      function AddTileData(elem, command) {
        const id = elem.id.split('-')[1];
        const terrain = window
          .getComputedStyle(elem, null)
          .getPropertyValue('background-color');
        const tileData = new TileData(id, terrain, elem, command);
        return tileData;
      }

      function GetNextTileNumber(key) {
        const currentTileId = Number(
          GlobalState.currentTileId ||
            GlobalState.currentSelectedUnitTile.id.split('-')[1]
        );

        switch (key) {
          case 'ArrowUp':
            return currentTileId - 40;
          case 'ArrowDown':
            return currentTileId + 40;
          case 'ArrowLeft':
            return currentTileId - 1;
          case 'ArrowRight':
            return currentTileId + 1;
          default:
            -1;
        }
      }

      function CanMoveInTerrain(terrainElement) {
        const id = GlobalState.currentSelectedUnitTile.querySelector('img').id;

        const unit = GlobalState.units[GlobalState.playerTurn][id];

        if (!unit) {
          console.log(`No unit found for ${id}`);
          return false;
        }
        const terrain = Array.from(terrainElement.classList).find(
          (c) => c.split('-')[0] === 'terrain'
        );

        if (!terrain) {
          console.log(`Not a terrain: ${terrain}`);
          return false;
        }

        const canMove = !!unit.canMoveInTerrain.find(
          (t) => t === terrain.split('-')[1]
        );

        return canMove;
      }

      function IsUndoMove(key, nextTile) {
        const { path } = GlobalState;

        const lastTile = path[path.length - 1];

        switch (key) {
          case 'ArrowUp':
            return lastTile.command === 'ArrowDown';
          case 'ArrowDown':
            return lastTile.command === 'ArrowUp';
          case 'ArrowLeft':
            return lastTile.command === 'ArrowRight';
          case 'ArrowRight':
            return lastTile.command === 'ArrowLeft';
          default:
            return false;
        }
      }

      function UndoMove(elem) {
        const { path } = GlobalState;

        const lastTile = path[path.length - 1];

        document.getElementById(`tile-${lastTile.id}`).style.backgroundColor =
          lastTile.terrainColor;

        GlobalState.path.pop();
        GlobalState.currentTileId = Number(elem.id.split('-')[1]);
      }

      function AlreadyMovedOnTile(nextTileNumber) {
        const { path } = GlobalState;

        return !!path.find(
          (tileData) => Number(tileData.id) === nextTileNumber
        );
      }

      function TileIsOccupied(elem) {
        return !!elem.querySelector('img');
      }

      function AddPath(key, nextTileElem) {
        GlobalState.currentTileId = Number(nextTileElem.id.split('-')[1]);
        const tileData = AddTileData(nextTileElem, key);
        GlobalState.path.push(tileData);
        nextTileElem.style.backgroundColor = 'purple';
      }

      function RemoveUnitElement() {
        document.removeEventListener('keydown', EventListener);

        const unitElement =
          GlobalState.currentSelectedUnitTile.querySelector('img');

        GlobalState.currentSelectedUnitElement = unitElement;

        GlobalState.currentSelectedUnitTile.removeChild(unitElement);
      }

      function AddUnitElement() {
        const { currentTileId, currentSelectedUnitTile, units, playerTurn } =
          GlobalState;
        const terrainElement = document.getElementById(`tile-${currentTileId}`);
        const unitElement = GlobalState.currentSelectedUnitElement;
        const id = unitElement.id;

        units[playerTurn][id].tileElement = terrainElement;

        terrainElement.appendChild(unitElement);
        terrainElement.addEventListener('mousedown', SelectUnit);
      }

      function ResetPath() {
        GlobalState.path.forEach((tile) => {
          tile.element.style.backgroundColor = tile.terrainColor;
        });
        GlobalState.path = [];
      }

      function ResetSelectedTile() {
        GlobalState.currentSelectedUnitTile = null;
        GlobalState.currentTileId = null;
        GlobalState.currentSelectedUnitElement = null;
      }

      function ReachedMovementRange() {
        const { currentSelectedUnitElement, path, playerTurn } = GlobalState;

        const currentUnit =
          GlobalState.units[playerTurn][currentSelectedUnitElement.id];

        return path.length >= currentUnit.movementRange;
      }

      function EndTurn() {
        const { playerTurn, numberOfPlayers, units } = GlobalState;

        // Remove event listeners for the current player's units
        Object.keys(units[playerTurn]).forEach((id) => {
          console.log(
            'remove event listener from',
            units[playerTurn][id].tileElement
          );
          units[playerTurn][id].tileElement.removeEventListener(
            'mousedown',
            SelectUnit
          );
        });

        // Update the player turn
        if (playerTurn === numberOfPlayers) {
          GlobalState.turn++;
          GlobalState.playerTurn = 1;
        } else {
          GlobalState.playerTurn++;
        }

        // Update the stats display
        document.getElementById('stats-day').innerHTML =
          'Day: ' + GlobalState.turn;
        document.getElementById('stats-player').innerHTML =
          'Player ' + GlobalState.playerTurn;

        // Add event listeners for the new player's units
        Object.keys(units[GlobalState.playerTurn]).forEach((id) => {
          console.log(
            'add event listener to',
            units[GlobalState.playerTurn][id].tileElement
          );
          units[GlobalState.playerTurn][id].tileElement.addEventListener(
            'mousedown',
            SelectUnit
          );
        });
      }

      function EndTurn() {
        const { playerTurn, numberOfPlayers, units } = GlobalState;

        // Remove event listeners for the current player's units
        Object.keys(units[playerTurn]).forEach((id) => {
          console.log(
            'remove event listener from',
            units[playerTurn][id].tileElement
          );
          units[playerTurn][id].tileElement.removeEventListener(
            'mousedown',
            SelectUnit
          );
        });

        // Update the player turn
        if (playerTurn === numberOfPlayers) {
          GlobalState.turn++;
          GlobalState.playerTurn = 1;
        } else {
          GlobalState.playerTurn++;
        }

        // Update the stats display
        document.getElementById('stats-day').innerHTML =
          'Day: ' + GlobalState.turn;
        document.getElementById('stats-player').innerHTML =
          'Player ' + GlobalState.playerTurn;

        // Add event listeners for the new player's units
        Object.keys(units[GlobalState.playerTurn]).forEach((id) => {
          console.log(
            'add event listener to',
            units[GlobalState.playerTurn][id].tileElement
          );
          units[GlobalState.playerTurn][id].tileElement.addEventListener(
            'mousedown',
            SelectUnit
          );
        });
      }

      function GetUnitFormElement(element) {
        element.querySelector('img');
      }
    </script>

    <script>
      let GlobalState = {
        path: [], // TileData for current unit path
        currentTileId: null, // number
        currentSelectedUnitTile: null, // element
        currentSelectedUnitElement: null,
        units: { 1: {}, 2: {}, 3: {}, 4: {} },
        turn: 1,
        playerTurn: 1,
        numberOfPlayers: 2,
        playerColors: { 1: 'green', 2: 'red', 3: 'blue', 4: 'yellow' },
      };
    </script>

    <script>
      const EventListener = (event) => {
        const { key } = event;
        const { path, currentSelectedUnitTile } = GlobalState;
        event.preventDefault();
        event.stopPropagation();

        if (
          ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].find(
            (command) => command === key
          )
        ) {
          const nextTileNumber = GetNextTileNumber(key);
          const nextTileElem = document.getElementById(
            `tile-${nextTileNumber}`
          );

          if (!nextTileElem) {
            return;
          }

          if (IsUndoMove(key, nextTileNumber)) {
            UndoMove(nextTileElem);
            return;
          }

          if (AlreadyMovedOnTile(nextTileNumber)) {
            return;
          }

          if (TileIsOccupied(nextTileElem)) {
            console.log('Tile is occupied');
            return;
          }

          if (!CanMoveInTerrain(nextTileElem)) {
            console.log('Unit cant move in this terrain');
            return;
          }

          if (ReachedMovementRange()) {
            console.log('Out of range');
            return;
          }

          AddPath(key, nextTileElem);

          return;
        }

        if (key === 'Enter') {
          RemoveUnitElement();
          ResetPath();
          AddUnitElement();
          ResetSelectedTile();
          return;
        }

        if (key === 'Escape') {
          document.removeEventListener('keydown', EventListener);
          GlobalState.currentSelectedUnitTile.addEventListener(
            'mousedown',
            SelectUnit
          );

          ResetPath();
          ResetSelectedTile();
          return;
        }
      };
    </script>

    <script>
      /* Game Interactive Logic */

      const SelectUnit = (event) => {
        const { target } = event;
        const { currentSelectedUnitTile, path, currentTileId } = GlobalState;

        if (currentSelectedUnitTile) {
          document.removeEventListener('keydown', EventListener);
          GlobalState.currentSelectedUnitTile.addEventListener(
            'mousedown',
            SelectUnit
          );

          ResetPath();
          ResetSelectedTile();
        }

        GlobalState.currentSelectedUnitTile = target;
        GlobalState.currentSelectedUnitElement = target.querySelector('img');

        target.removeEventListener('mousedown', SelectUnit);

        const tileData = AddTileData(target, 'start');
        GlobalState.path.push(tileData);

        GlobalState.currentSelectedUnitTile.style.backgroundColor = 'purple';

        document.addEventListener('keydown', EventListener);
      };
    </script>

    <script>
      /* Initial values */
      const startPositionsPlayer1 = [
        { tile: '20', unit: new Unit('infantry') },
        { tile: '56', unit: new Unit('tank') },
      ];

      const startPositionsPlayer2 = [
        { tile: '306', unit: new Unit('infantry') },
        { tile: '307', unit: new Unit('tank') },
      ];

      startPositionsPlayer1.forEach(({ tile, unit }) => {
        const terrainElement = document.getElementById(`tile-${tile}`);
        const unitImage = AddUnitImage(terrainElement, unit, 1);
        terrainElement.appendChild(unitImage);
        GlobalState.units[1][unit.id] = unit;

        terrainElement.addEventListener('mousedown', SelectUnit);
        unit.tileElement = terrainElement;
      });

      startPositionsPlayer2.forEach(({ tile, unit }) => {
        const terrainElement = document.getElementById(`tile-${tile}`);
        const unitImage = AddUnitImage(terrainElement, unit, 2);
        unitImage.setAttribute('class', 'flipped-right');
        terrainElement.appendChild(unitImage);
        GlobalState.units[2][unit.id] = unit;
        unit.tileElement = terrainElement;
        console.log(terrainElement);
        //terrainElement.addEventListener('mousedown', SelectUnit);
      });
    </script>
    <script>
      document.getElementById('end-turn').addEventListener('click', EndTurn);
    </script>
  </body>
</html>
