<html>
  <head>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div id="map" class="grid-container">
      <!-- Example grid items -->
      <!-- <div class="grid-item"></div>
      <div class="grid-item"></div>
      <div class="grid-item"></div> -->
      <!-- Add more items as needed -->
  </div>

    <script>
      const htmlMap = document.getElementById("map");

      const size = 20 * 40;

      for (let i = 0; i < size; i++) {
        const element = document.createElement("div");
        element.setAttribute("class", "grid-item");
        element.id = "tile-" + i;

        if (i < size / 2) {

          if (Math.random() < 0.2) {
            element.setAttribute("class", "terrain-forest");
          }
          else {
            element.setAttribute("class", "terrain-grass");
            // const img = document.createElement("img");
            // img.src = "grass.jpeg";
            // img.style.height = "40px";
            // element.appendChild(img);
          }
        }
        else {
          element.setAttribute("class", "terrain-water"); 
        }
        
        htmlMap.appendChild(element);
      }
    </script>

    
    <script>
      /* Classes */
      class TileData {
        id = "";
        terrainColor = "";
        element = null;
        command = "";

        constructor(id, t, e, c) {
          this.id = id;
          this.terrainColor = t;
          this.element = e;
          this.command = c;
        }
      }

      class Unit {
        id = "";
        type = "";
        movementRange = 0;
        canMoveInTerrain = ["field", "woods", "mountain", "water"];

        constructor(type) {
          this.id = GenerateId();
          this.type = type;
          const { canMoveInTerrain, movementRange } = GetUnitLogic(type);
          this.canMoveInTerrain = canMoveInTerrain;
          this.movementRange = movementRange;
        }
      }

    </script>

    <script>
      /* Functions */

    function GenerateId() {
        return 'id-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
    }

    function GetUnitLogic(type = "")  {
      if (type === "infantry") {
        return { movementRange: 3, canMoveInTerrain: ["field", "woods", "mountain"]}
      }
      if (type === "tank") {
        return { movementRange: 6, canMoveInTerrain: ["field", "woods"]}
      }
      return { movementRange: 0, canMoveInTerrain: []}
    }

    function AddImg(tile, type) {
            const img = document.createElement("img");

            if (type === "infantry") {
              img.src = "units/infantry.png";
            }
            else if (type === "tank") {
              img.src = "units/tank.png";
            }
            img.style.pointerEvents = "none";
            img.style.height = "40px";
            img.style.width = "40px";
            img.setAttribute("class", "overlay-image");
            return img;
          }
      
      function AddTileData(elem, command) {
          const id = elem.id.split("-")[1];
          const terrain = window.getComputedStyle(elem, null).getPropertyValue("background-color");
          const tileData = new TileData(id, terrain, elem, command);
          return tileData;
        }

        function generateRandomId() {
          return 'id-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
        }
    </script>
      <script>
        /* Game Interactive Logic */

        let path = [];
    
        const SelectUnit = (event) => {
  
          const { target } = event;
          console.log(target);
  
          target.removeEventListener("mousedown", SelectUnit);
  
          const tileData = AddTileData(target, "start");
          path.push(tileData);
  
          target.style.backgroundColor = "purple";
          
          let currentTile;
          
          const EventListener = (event) => {
  
            const { key } = event;
            event.preventDefault();
            event.stopPropagation();
  
            const startTile = Number(currentTile || (target.id.split("-")[1])); 
  
            if (key === "ArrowUp") {
              const nextTile = startTile - 40;
              const elem = document.getElementById(`tile-${nextTile}`);
              if (elem) {
  
                const lastTile = path[path.length -1];
                if (lastTile.command === "ArrowDown") {
                  document.getElementById(`tile-${lastTile.id}`).style.backgroundColor = lastTile.terrainColor;
                  path.pop();
                  currentTile = Number(elem.id.split("-")[1]);
                }
                else {
                  currentTile = Number(elem.id.split("-")[1]);
  
                  const exists = path.find(tileData => Number(tileData.id) === currentTile);
  
                  if (exists) {
                    console.log("No path crossing!");
                    currentTile = Number(lastTile.id);
                  }
                  else {
                    const tileData = AddTileData(elem, "ArrowUp");
                    path.push(tileData)
                    elem.style.backgroundColor = "purple";
                  }
                }
                
              }
            }
            else if (key === "ArrowDown") {
              const nextTile = startTile + 40;
              const elem = document.getElementById(`tile-${nextTile}`);
              if (elem) {
  
                const lastTile = path[path.length -1];
                if (lastTile.command === "ArrowUp") {
                  document.getElementById(`tile-${lastTile.id}`).style.backgroundColor = lastTile.terrainColor;
                  path.pop();
                  currentTile = Number(elem.id.split("-")[1]);
                }
                else {
                  currentTile = Number(elem.id.split("-")[1]);
  
                  const exists = path.find(tileData => Number(tileData.id) === currentTile);
  
                  if (exists) {
                    console.log("No path crossing!");
                    currentTile = Number(lastTile.id);
                  }
                  else {
  
                  const tileData = AddTileData(elem, "ArrowDown");
                  path.push(tileData)
                  elem.style.backgroundColor = "purple";
  
                  }
                }
                
              }
            }
            else if (key === "ArrowRight") {
              const nextTile = startTile + 1;
              const elem = document.getElementById(`tile-${nextTile}`);
              if (elem) {
                const lastTile = path[path.length -1];
                if (lastTile.command === "ArrowLeft") {
                  document.getElementById(`tile-${lastTile.id}`).style.backgroundColor = lastTile.terrainColor;
                  path.pop();
                  currentTile = Number(elem.id.split("-")[1]);
                }
                else {
                  currentTile = Number(elem.id.split("-")[1]);
                  const exists = path.find(tileData => Number(tileData.id) === currentTile);
  
                  if (exists) {
                    console.log("No path crossing!");
                    currentTile = Number(lastTile.id);
                  }
                  else {
                  const tileData = AddTileData(elem, "ArrowRight");
                  path.push(tileData)
                  elem.style.backgroundColor = "purple";
                  }
                }
                
              }
            }
            else if (key === "ArrowLeft") {
              const nextTile = startTile - 1;
              const elem = document.getElementById(`tile-${nextTile}`);
              if (elem) {
  
                const lastTile = path[path.length -1];
                if (lastTile.command === "ArrowRight") {
                  document.getElementById(`tile-${lastTile.id}`).style.backgroundColor = lastTile.terrainColor;
                  path.pop();
                  currentTile = Number(elem.id.split("-")[1]);
                }
                else {
                  currentTile = Number(elem.id.split("-")[1]);
                  const exists = path.find(tileData => Number(tileData.id) === currentTile);
  
                  if (exists) {
                    console.log("No path crossing!");
                    currentTile = Number(lastTile.id);
                  }
                  else {
                    const tileData = AddTileData(elem, "ArrowLeft");
                    path.push(tileData);
                    elem.style.backgroundColor = "purple";
                  }
                }
              }
            }
            else if (key === "Enter") {
              document.removeEventListener("keydown", EventListener);
              const image = target.querySelector("img");
              target.removeChild(image);
              path.forEach(tile => {
                tile.element.style.backgroundColor = tile.terrainColor;
              });
              path = [];
              const elem = document.getElementById(`tile-${currentTile}`);
              elem.appendChild(image);
              elem.addEventListener("mousedown", SelectUnit);
              //target = elem;
              currentTile = null;
              
            }
            else if (key === "Escape") {
              document.removeEventListener("keydown", EventListener);
              target.addEventListener("mousedown", SelectUnit);
  
              path.forEach(tile => {
                tile.element.style.backgroundColor = tile.terrainColor;
              });
            
            path = []; 
            const elem = document.getElementById(`tile-${currentTile}`);
            currentTile = null;
            }
          }       
  
          document.addEventListener("keydown", EventListener); 
        }
    
      </script>

    <script>
      /* Initial values */
      const startPositions = [{ tile: "20", unit: new Unit("infantry")  }, { tile: "56", unit: new Unit("tank")}];

      startPositions.forEach(({ tile, unit}) => {
        const terrainElement = document.getElementById(`tile-${tile}`);
        const unitImage = AddImg(terrainElement, unit.type);
        terrainElement.appendChild(unitImage);

        console.log(terrainElement);

        terrainElement.addEventListener("mousedown", SelectUnit);
      })
    </script>


  </body>
</html>