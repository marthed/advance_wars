<html>
  <head>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="stats" class="stats">
      <div id="stats-day" class="stats-item">Day: 1</div>
      <div id="stats-player" class="stats-item">Player 1</div>
      <button id="end-turn" class="stats-button">End turn</button>
    </div>
    <div id="map" class="grid-container"></div>
    <div id="unit-action-modal" class="hidden"></div>

    <script>
      /* Terrain Generation */
      function CreateTerrainImage(terrainType) {
        const img = document.createElement('img');

        img.src = `terrain/${terrainType}.png`;
        img.classList.add('terrain-image');
        //img.classList.add(`terrain-${terrainType}`);
        return img;
      }
    </script>

    <script>
      /* Generate Map */
      const htmlMap = document.getElementById('map');

      const size = 20 * 40;

      let waterTiles = [];

      for (let i = 0; i < size; i++) {
        const element = document.createElement('div');
        element.classList.add('grid-item');
        element.id = 'tile-' + i;

        if (i < size / 2) {
          if (Math.random() < 0.2) {
            element.classList.add('terrain-forest');
            const img = CreateTerrainImage('forest');
            element.appendChild(img);
          } else if (Math.random() < 0.1) {
            element.classList.add('terrain-mountain');
            const img = CreateTerrainImage('mountain');
            element.appendChild(img);
          } else {
            element.classList.add('terrain-field');
            const img = CreateTerrainImage('field');
            element.appendChild(img);
          }
        } else {
          element.classList.add('terrain-water');
          const img = CreateTerrainImage('water');
          element.appendChild(img);
          waterTiles.push(img);
        }

        const path = document.createElement('div');
        path.classList.add('path');

        element.appendChild(path);

        htmlMap.appendChild(element);
      }
    </script>
    <script>
      const WaterAnimation = {
        numberOfTilesPerInterval: waterTiles.length,
        max: waterTiles.length - 1,
        min: 0,
        paths: ['water.png', 'water_1.png', 'water_2.png', 'water_3.png'],
      };
      /* Water animation */
      setInterval(() => {
        const { numberOfTilesPerInterval, max, min, paths } = WaterAnimation;

        for (let i = 0; i < numberOfTilesPerInterval; i++) {
          const index = Math.floor(Math.random() * (max - min + 1)) + min;
          const image = Math.floor(Math.random() * (3 - 0 + 1)) + 0;

          waterTiles[index].src = `terrain/${paths[image]}`;
        }
      }, 2000);
    </script>

    <script>
      /* Classes */
      class TileData {
        id = '';
        terrainColor = '';
        element = null;
        command = '';

        constructor(id, t, e, c) {
          this.id = id;
          this.terrainColor = t;
          this.element = e;
          this.command = c;
        }
      }

      class Unit {
        id = '';
        type = '';
        movementRange = 0;
        canMoveInTerrain = ['field', 'forest', 'mountain', 'water'];
        tileElement = null;
        hitPoints = 10;
        directAttack = true;
        directDefense = true;

        constructor(type) {
          this.id = GenerateId();
          this.type = type;
          const {
            canMoveInTerrain,
            movementRange,
            directAttack = true,
            directDefense = true,
          } = GetUnitLogic(type);
          this.canMoveInTerrain = canMoveInTerrain;
          this.movementRange = movementRange;
        }
      }
    </script>

    <script>
      /* Functions */

      function GenerateId() {
        return 'unitId-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
      }

      function GetUnitLogic(type = '') {
        if (type === 'infantry') {
          return {
            movementRange: 3,
            canMoveInTerrain: ['field', 'forest', 'mountain'],
          };
        }
        if (type === 'tank') {
          return { movementRange: 6, canMoveInTerrain: ['field', 'forest'] };
        }
        if (type === 'rpg') {
          return {
            movementRange: 2,
            canMoveInTerrain: ['field', 'forest', 'mountain'],
          };
        }
        if (type === 'rockets') {
          return {
            movementRange: 3,
            canMoveInTerrain: ['field', 'forest'],
            directAttack: false,
            directDefense: false,
          };
        }

        return { movementRange: 0, canMoveInTerrain: [] };
      }

      function CreateUnitElement(unit, player) {
        const element = document.createElement('div');
        element.classList.add('unit');
        element.setAttribute('player', player);

        const unitImage = CreateUnitImage(unit, player);

        const hpElement = document.createElement('span');
        hpElement.classList.add('hp');
        hpElement.style.zIndex = '2';
        hpElement.innerHTML = unit.hitPoints;

        const color = GlobalState.playerColors[player];
        hpElement.classList.add(`color-${color}`);

        element.appendChild(unitImage);
        element.appendChild(hpElement);

        element.id = unit.id;

        return element;
      }

      function CreateUnitImage(unit, player) {
        const { type, id } = unit;
        const img = document.createElement('img');

        const color = GlobalState.playerColors[player];

        if (type === 'infantry') {
          img.src = `units/${type}_${color}.png`;
        } else if (type === 'rpg') {
          img.src = `units/infantry_${type}_${color}.png`;
        } else if (type === 'rockets') {
          img.src = `units/${type}_${color}.png`;
        } else {
          img.src = `units/${type}.png`;
        }

        img.classList.add('overlay-image');
        img.classList.add('unit-image');

        if (player === 2) {
          img.classList.add('flipped-right');
        }

        return img;
      }

      function AddTileData(elem, command) {
        const id = elem.id.split('-')[1];
        const terrain = window
          .getComputedStyle(elem, null)
          .getPropertyValue('background-color');
        const tileData = new TileData(id, terrain, elem, command);
        return tileData;
      }

      function GetNextTileNumber(key) {
        const currentTileId = Number(
          GlobalState.currentTileId ||
            GlobalState.currentSelectedUnitTile.id.split('-')[1]
        );

        switch (key) {
          case 'ArrowUp':
            return currentTileId - 40;
          case 'ArrowDown':
            return currentTileId + 40;
          case 'ArrowLeft':
            return currentTileId - 1;
          case 'ArrowRight':
            return currentTileId + 1;
          default:
            -1;
        }
      }

      function GetUnitIDFromTerrainElement(terrainElement) {
        return terrainElement.querySelector(`div.unit`)?.id;
      }

      function CanMoveInTerrain(terrainElement) {
        const id = GetUnitIDFromTerrainElement(
          GlobalState.currentSelectedUnitTile
        );

        const unit = GlobalState.units[GlobalState.playerTurn][id];

        if (!unit) {
          console.log(`No unit found for ${id}`);
          return false;
        }
        const terrain = Array.from(terrainElement.classList).find(
          (c) => c.split('-')[0] === 'terrain'
        );

        if (!terrain) {
          console.log(`Not a terrain: ${terrain}`);
          return false;
        }

        const canMove = !!unit.canMoveInTerrain.find(
          (t) => t === terrain.split('-')[1]
        );

        return canMove;
      }

      function IsUndoMove(key, nextTile) {
        const { path } = GlobalState;

        const lastTile = path[path.length - 1];

        switch (key) {
          case 'ArrowUp':
            return lastTile.command === 'ArrowDown';
          case 'ArrowDown':
            return lastTile.command === 'ArrowUp';
          case 'ArrowLeft':
            return lastTile.command === 'ArrowRight';
          case 'ArrowRight':
            return lastTile.command === 'ArrowLeft';
          default:
            return false;
        }
      }

      function UndoMove(elem) {
        const { path } = GlobalState;

        const lastTile = path[path.length - 1];

        document
          .getElementById(`tile-${lastTile.id}`)
          .querySelector('.path')
          .classList.remove('path__highlighted');

        GlobalState.path.pop();
        GlobalState.currentTileId = Number(elem.id.split('-')[1]);
      }

      function AlreadyMovedOnTile(nextTileNumber) {
        const { path } = GlobalState;

        return !!path.find(
          (tileData) => Number(tileData.id) === nextTileNumber
        );
      }

      function TileIsOccupied(elem) {
        return !!GetUnitIDFromTerrainElement(elem);
      }

      function AddPath(key, nextTileElem) {
        GlobalState.currentTileId = Number(nextTileElem.id.split('-')[1]);
        const tileData = AddTileData(nextTileElem, key);
        GlobalState.path.push(tileData);

        nextTileElem.querySelector('.path').classList.add('path__highlighted');

        //nextTileElem.style.backgroundColor = 'purple';
      }

      function RemoveUnitElement() {
        document.removeEventListener('keydown', EventListener);

        const unitElement =
          GlobalState.currentSelectedUnitTile.querySelector('div.unit');

        GlobalState.currentSelectedUnitElement = unitElement;

        GlobalState.currentSelectedUnitTile.removeChild(unitElement);
      }

      function AddUnitElement(settings = {}) {
        const { currentTileId, currentSelectedUnitTile, units, playerTurn } =
          GlobalState;
        const terrainElement = document.getElementById(`tile-${currentTileId}`);
        const unitElement = GlobalState.currentSelectedUnitElement;
        const id = unitElement.id;

        units[playerTurn][id].tileElement = terrainElement;

        terrainElement.appendChild(unitElement);
        if (settings.canMove) {
          terrainElement.addEventListener('mousedown', SelectUnit);
        }
        if (settings.hasMoved) {
          unitElement.classList.add('hasMoved');
        }

        if (settings.flipped) {
          unitElement
            .querySelector('img.unit-image')
            .classList.add('flipped-right');
          //unitElement.classList.add('flipped-right');
        }
      }

      function ResetPath() {
        GlobalState.path.forEach((tile) => {
          tile.element
            .querySelector('.path')
            .classList.remove('path__highlighted');
          //tile.element.style.backgroundColor = tile.terrainColor;
        });
        GlobalState.path = [];
      }

      function ResetSelectedTile() {
        GlobalState.currentSelectedUnitTile = null;
        GlobalState.currentTileId = null;
        GlobalState.currentSelectedUnitElement = null;
      }

      function ReachedMovementRange() {
        const { currentSelectedUnitElement, path, playerTurn } = GlobalState;

        const currentUnit =
          GlobalState.units[playerTurn][currentSelectedUnitElement.id];

        return path.length >= currentUnit.movementRange + 1;
      }

      function EndTurn() {
        const { playerTurn, numberOfPlayers, units } = GlobalState;

        DeselectUnit();

        // Remove event listeners for the current player's units
        Object.keys(units[playerTurn]).forEach((id) => {
          units[playerTurn][id].tileElement.removeEventListener(
            'mousedown',
            SelectUnit
          );
          const movedUnit =
            units[playerTurn][id].tileElement.querySelector('.hasMoved');

          if (movedUnit) {
            movedUnit.classList.remove('hasMoved');
          }
        });

        // Update the player turn
        if (playerTurn === numberOfPlayers) {
          GlobalState.turn++;
          GlobalState.playerTurn = 1;
        } else {
          GlobalState.playerTurn++;
        }

        // Update the stats display
        document.getElementById('stats-day').innerHTML =
          'Day: ' + GlobalState.turn;
        document.getElementById('stats-player').innerHTML =
          'Player ' + GlobalState.playerTurn;

        // Add event listeners for the new player's units
        Object.keys(units[GlobalState.playerTurn]).forEach((id) => {
          units[GlobalState.playerTurn][id].tileElement.addEventListener(
            'mousedown',
            SelectUnit
          );
        });
      }

      function GetUnitFromElement(element) {
        return element.querySelector('div.unit');
      }

      function DeselectUnit() {
        document.removeEventListener('keydown', EventListener);
        GlobalState.currentSelectedUnitTile?.addEventListener(
          'mousedown',
          SelectUnit
        );

        ResetPath();
        ResetSelectedTile();
      }

      function MapDirection(id) {
        const { currentTileId } = GlobalState;
        if (currentTileId - 1 === id) {
          return 'ArrowLeft';
        }
        if (currentTileId + 1 === id) {
          return 'ArrowRight';
        }
        if (currentTileId - 40 === id) {
          return 'ArrowUp';
        }
        if (currentTileId + 40 === id) {
          return 'ArrowDown';
        }
      }

      const UnitActions = (event) => {
        const { key } = event;
        const { adjacentEnemyTiles } = GlobalState;
        const actions = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];

        if (actions.find((command) => command === key)) {
          const enemyTile = adjacentEnemyTiles.find(
            (tile) => tile.direction === key
          );

          if (enemyTile) {
            adjacentEnemyTiles.forEach(({ tileElement }) => {
              tileElement
                .querySelector('.path')
                .classList.remove('path__highlighted'); // Change to image later
            });

            enemyTile.tileElement
              .querySelector('.path')
              .classList.add('path__highlighted'); // Change to image later
          }
        }
      };

      function OpenUnitActionModal() {
        const { currentTileId } = GlobalState;
        const currentTile = document.getElementById(`tile-${currentTileId}`);

        document.getElementById('map').style.overflow = 'hidden';

        const modal = document.getElementById('unit-action-modal');
        modal.classList.remove('hidden');

        const rect = currentTile.getBoundingClientRect();
        modal.style.left = rect.left + 50 + 'px';
        modal.style.top = rect.top + 50 + 'px';

        document.addEventListener('keydown', UnitActions);
      }

      function AdjacentEnemyUnits() {
        const { currentTileId, playerTurn } = GlobalState;

        const surroundingTiles = [
          currentTileId - 1,
          currentTileId + 1,
          currentTileId - 40,
          currentTileId + 40,
        ]
          .map((id) => ({
            tileElement: document.getElementById(`tile-${id}`),
            direction: MapDirection(id),
          }))
          .filter((tile) => !!tile.tileElement);

        const enemyTiles = surroundingTiles.filter(
          ({ tileElement, direction }) => {
            const unit = GetUnitFromElement(tileElement);
            if (unit) {
              if (Number(unit.getAttribute('player')) !== playerTurn) {
                return true;
              }
              return false;
            }
            return false;
          }
        );

        if (!enemyTiles.length) {
          return false;
        }

        GlobalState.adjacentEnemyTiles = enemyTiles;

        return true;
      }
    </script>

    <script>
      /* Combat Logic */
    </script>

    <script>
      let GlobalState = {
        path: [], // TileData for current unit path
        currentTileId: null, // number
        currentSelectedUnitTile: null, // element
        currentSelectedUnitElement: null,
        adjacentEnemyTiles: [],
        units: { 1: {}, 2: {}, 3: {}, 4: {} },
        turn: 1,
        playerTurn: 1,
        numberOfPlayers: 2,
        playerColors: { 1: 'green', 2: 'red', 3: 'blue', 4: 'yellow' },
      };
    </script>

    <script>
      const EventListener = (event) => {
        const { key } = event;
        const { path, currentSelectedUnitTile } = GlobalState;
        event.preventDefault();
        event.stopPropagation();

        if (
          ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].find(
            (command) => command === key
          )
        ) {
          const nextTileNumber = GetNextTileNumber(key);
          const nextTileElem = document.getElementById(
            `tile-${nextTileNumber}`
          );

          if (!nextTileElem) {
            return;
          }

          if (IsUndoMove(key, nextTileNumber)) {
            UndoMove(nextTileElem);
            return;
          }

          if (AlreadyMovedOnTile(nextTileNumber)) {
            return;
          }

          if (TileIsOccupied(nextTileElem)) {
            console.log('Tile is occupied');
            return;
          }

          if (!CanMoveInTerrain(nextTileElem)) {
            console.log('Unit cant move in this terrain');
            return;
          }

          if (ReachedMovementRange()) {
            console.log('Out of range');
            return;
          }

          AddPath(key, nextTileElem);

          return;
        }

        if (key === 'Enter') {
          if (GlobalState.path.length > 1) {
            RemoveUnitElement();
            ResetPath();
            AddUnitElement({
              hasMoved: true,
              flipped: GlobalState.playerTurn === 2,
            });
            if (AdjacentEnemyUnits()) {
              OpenUnitActionModal();
            } else {
              ResetSelectedTile();
            }

            return;
          } else {
            DeselectUnit();
          }
        }

        if (key === 'Escape') {
          DeselectUnit();
          return;
        }
      };
    </script>

    <script>
      /* Game Interactive Logic */

      const SelectUnit = (event) => {
        const { target } = event;
        const { currentSelectedUnitTile, path, currentTileId } = GlobalState;

        if (currentSelectedUnitTile) {
          document.removeEventListener('keydown', EventListener);
          GlobalState.currentSelectedUnitTile.addEventListener(
            'mousedown',
            SelectUnit
          );

          ResetPath();
          ResetSelectedTile();
        }

        GlobalState.currentSelectedUnitTile = target;
        GlobalState.currentSelectedUnitElement =
          target.querySelector('div.unit');

        target.removeEventListener('mousedown', SelectUnit);

        const tileData = AddTileData(target, 'start');
        GlobalState.path.push(tileData);

        GlobalState.currentSelectedUnitTile
          .querySelector('.path')
          .classList.add('path__highlighted');
        //GlobalState.currentSelectedUnitTile.style.backgroundColor = 'purple';

        document.addEventListener('keydown', EventListener);
      };
    </script>

    <script>
      /* Initial values */
      const startPositionsPlayer1 = [
        { tile: '83', unit: new Unit('infantry') },
        { tile: '123', unit: new Unit('tank') },
        { tile: '162', unit: new Unit('rpg') },
      ];

      const startPositionsPlayer2 = [
        { tile: '85', unit: new Unit('infantry') },
        { tile: '128', unit: new Unit('tank') },
        { tile: '129', unit: new Unit('rpg') },
      ];

      startPositionsPlayer1.forEach(({ tile, unit }) => {
        const terrainElement = document.getElementById(`tile-${tile}`);
        //const unitImage = CreateUnitImage(unit, 1);
        const unitElement = CreateUnitElement(unit, 1);

        terrainElement.appendChild(unitElement);
        GlobalState.units[1][unit.id] = unit;

        terrainElement.addEventListener('mousedown', SelectUnit);
        unit.tileElement = terrainElement;
      });

      startPositionsPlayer2.forEach(({ tile, unit }) => {
        const terrainElement = document.getElementById(`tile-${tile}`);
        const unitElement = CreateUnitElement(unit, 2);

        terrainElement.appendChild(unitElement);
        GlobalState.units[2][unit.id] = unit;
        unit.tileElement = terrainElement;
        //terrainElement.addEventListener('mousedown', SelectUnit);
      });
    </script>
    <script>
      document.getElementById('end-turn').addEventListener('click', EndTurn);
    </script>
  </body>
</html>
